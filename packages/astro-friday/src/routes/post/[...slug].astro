---
import { render } from 'astro:content'
import config from 'virtual:astro-friday-config'
import ArticleDetail from '../../components/ArticleDetail.astro'
import ArticleTOC from '../../components/ArticleTOC.astro'
import DefaultLayout from '../../layouts/Default.astro'
import { getPostList } from '../../utils/content/post'
import { getPath } from '../../utils/path'

export async function getStaticPaths() {
  const entryList = await getPostList()

  return entryList.map(entry => ({
    params: {
      collection: entry.collection,
      slug: entry.id,
    },
    props: {
      entry,
    },
  }))
}

// const { collection, slug } = Astro.params

const { entry } = Astro.props

const fKeys = config.post.frontmatterKeys

const {
  Content,
  headings,
  // @ts-expect-error never
} = await render(entry)

const toc = {
  ...config.post.toc,
  ...entry.data[fKeys.toc],
}
---

<DefaultLayout
  seo={{
    noindex: entry.data[fKeys.draft],
    nofollow: entry.data[fKeys.draft],
    openGraph: {
      basic: {
        title: entry.data[fKeys.title],
        type: 'article',
        image: getPath(
          'og',
          config.post.pathStyle === 'collection/id'
            ? [entry.collection, entry.id]
            : [entry.id],
          { host: Astro.url.origin },
        ),
        url: Astro.url.href,
      },
      article: {
        publishedTime: entry.data[fKeys.created],
        modifiedTime: entry.data[fKeys.modified] || entry.data[fKeys.created],
        authors: [entry.data[fKeys.author]],
        section: undefined,
        tags: entry.data[fKeys.tags],
      },
      image: {
        type: 'image/png',
        width: 1200,
        height: 630,
        alt: entry.data[fKeys.title],
      },
    },
    extend: {
      meta: [
        { name: 'keywords', content: entry.data[fKeys.keywords].join(', ') || '' },
      ],
    },
  }}
>
  <ArticleDetail {entry}>
    { toc.enable && headings.length ? (<ArticleTOC {headings} {toc} />) : null }

    <Content />
  </ArticleDetail>
</DefaultLayout>
